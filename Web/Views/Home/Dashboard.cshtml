@model Web.ViewModels.DashboardViewModel

@{
  ViewData["Title"]="Dashboard";
}

<div class="container-fluid mt-4">
  <!-- Welcome Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card bg-gradient-primary text-white shadow-sm border-0">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h3 class="mb-1">
                <i class="bi bi-speedometer2 me-2"></i> Welcome Back, @User.Identity?.Name!
              </h3>
              <p class="mb-0 opacity-90">Your personal rental dashboard - Track your rentals, payments, and more</p>
            </div>
            <div class="col-md-4 text-md-end mt-3 mt-md-0">
              <div class="text-white bg-opacity-20 rounded-pill px-4 py-2 d-inline-block">
                <i class="bi bi-calendar-check me-1"></i> @DateTime.Now.ToString("dddd, MMMM dd, yyyy")
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="row g-4 mb-4">
    <!-- Total Rentals -->
    <div class="col-xl-4 col-md-4 col-sm-6">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <p class="text-muted mb-1 small">TOTAL RENTALS</p>
              <h2 class="mb-0 fw-bold">@Model.TotalRentals</h2>
            </div>
            <div class="bg-primary bg-opacity-10 text-primary p-3 rounded-3">
              <i class="bi bi-file-text fs-4"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Active Rentals -->
    <div class="col-xl-4 col-md-4 col-sm-6">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <p class="text-muted mb-1 small">ACTIVE RENTALS</p>
              <h2 class="mb-0 fw-bold text-warning">@Model.ActiveRentals</h2>
            </div>
            <div class="bg-warning bg-opacity-10 text-warning p-3 rounded-3">
              <i class="bi bi-car-front fs-4"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Completed Rentals -->
    <div class="col-xl-4 col-md-4 col-sm-6">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <p class="text-muted mb-1 small">COMPLETED</p>
              <h2 class="mb-0 fw-bold text-success">@Model.CompletedRentals</h2>
            </div>
            <div class="bg-success bg-opacity-10 text-success p-3 rounded-3">
              <i class="bi bi-check-circle fs-4"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Cancelled Rentals -->
    <div class="col-xl-4 col-md-4 col-sm-6">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <p class="text-muted mb-1 small">Cancelled</p>
              <h2 class="mb-0 fw-bold text-danger">@Model.CancelledRentals</h2>
            </div>
            <div class="bg-danger bg-opacity-10 text-danger p-3 rounded-3">
              <i class="bi bi-x-circle-fill fs-4"></i>
            </div>
          </div>
        </div>  
      </div>
    </div>

    <!-- Total Paid -->
    <div class="col-xl-4 col-md-4 col-sm-6">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <p class="text-muted mb-1 small">TOTAL PAID</p>
              <h2 class="mb-0 fw-bold text-info">@Model.TotalPaidAmount.ToString("C")</h2>
            </div>
            <div class="bg-info bg-opacity-10 text-info p-3 rounded-3">
              <i class="bi bi-cash-stack fs-5"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Total Payments -->
    <div class="col-xl-4 col-md-4 col-sm-6">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <p class="text-muted mb-1 small">PAYMENTS</p>
              <h2 class="mb-0 fw-bold">@Model.TotalPayments</h2>
            </div>
            <div class="bg-secondary bg-opacity-10 text-secondary p-3 rounded-3">
              <i class="bi bi-credit-card fs-4"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Cars Rented -->
    <div class="col-xl-4 col-md-4 col-sm-6">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <p class="text-muted mb-1 small">CARS RENTED</p>
              <h2 class="mb-0 fw-bold text-purple">@Model.CarsRented</h2>
            </div>
            <div class="bg-secondary bg-opacity-10 text-bg-secondary p-3 rounded-3">
              <i class="bi bi-truck fs-4"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  
    <!-- Cars Available -->
  <div class="col-xl-4 col-md-4 col-sm-6">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <p class="text-muted mb-1 small">CARS Available</p>
            <h2 class="mb-0 fw-bold text-success">@Model.CarsAvailable</h2>
          </div>
          <div class="bg-success bg-opacity-10 text-success p-3 rounded-3">
            <i class="bi bi-truck fs-4"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

  <!-- Charts Section -->
 <div class="row g-4 mb-4">
        <!-- المخططات -->
        <div class="col-lg-6">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header">
                    <h5 class="mb-0 text-primary">
                        <i class="bi bi-graph-up me-2"></i> العقود الشهرية
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="rentalsChart" height="250"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header">
                    <h5 class="mb-0 text-success">
                        <i class="bi bi-graph-up-arrow me-2"></i> المدفوعات الشهرية
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="paymentsChart" height="250"></canvas>
                </div>
            </div>
        </div>
    </div>
  <!-- Active Contracts & Recent Payments -->
  <div class="row g-4 mb-4">
    <!-- Active Contracts -->
    <div class="col-lg-8">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
          <h5 class="mb-0 text-warning">
            <i class="bi bi-clock-history me-2"></i> Active Contracts
          </h5>
          <a asp-controller="Rentals" asp-action="Index" class="btn btn-sm btn-outline-primary">
            View All <i class="bi bi-arrow-right ms-1"></i>
          </a>
        </div>
        <div class="card-body">
          @if(Model.ActiveContracts.Any())
          {
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Contract</th>
                    <th>Car</th>
                    <th>Period</th>
                    <th class="text-end">Total</th>
                    <th class="text-end">Paid</th>
                    <th class="text-end">Remaining</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  @foreach(var contract in Model.ActiveContracts)
                  {
                    var remaining = (contract.FinalAmount??contract.TotalAmount)-contract.PaidAmount;
                    <tr>
                      <td>
                        <a asp-controller="Rentals" asp-action="Details" asp-route-id="@contract.Id"
                           class="text-decoration-none fw-bold text-primary">
                          #@contract.Id
                        </a>
                        <br>
                        <small class="text-muted">@contract.StartDate.ToString("MMM dd") - @contract.EndDate.ToString("MMM dd")</small>
                      </td>
                      <td>
                        @if(contract.Car!=null)
                        {
                          <div>
                            <strong>@contract.Car.Model</strong>
                            <br>
                            <small class="text-muted">@contract.Car.PlateNumber</small>
                          </div>
                        }
                        else
                        {
                          <span class="text-muted">Car info loading...</span>
                        }
                      </td>
                      <td>
                        <span class="badge bg-info text-dark">@((contract.EndDate-contract.StartDate).Days+1) days</span>
                      </td>
                      <td class="text-end fw-bold">@contract.TotalAmount.ToString("C")</td>
                      <td class="text-end text-success fw-bold">@contract.PaidAmount.ToString("C")</td>
                      <td class="text-end @(remaining>0 ? "text-danger fw-bold" : "text-success")">
                        @if(remaining>0)
                        {
                          @remaining.ToString("C")
                        }
                        else
                        {
                          <span class="badge bg-success">Paid</span>
                        }
                      </td>
                      <td>
                        <span class="badge bg-warning text-dark">@contract.Status</span>
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          }
          else
          {
            <div class="text-center py-5">
              <div class="mb-3">
                <i class="bi bi-inbox fs-1 text-muted"></i>
              </div>
              <h5 class="text-muted">No active contracts</h5>
              <p class="text-muted small mt-2">Start a new rental to see it here</p>
              <a asp-controller="Car" asp-action="Index" class="btn btn-primary mt-3">
                <i class="bi bi-car-front me-1"></i>  Cars
              </a>
            </div>
          }
        </div>
      </div>
    </div>

    <!-- Recent Payments -->
    <div class="col-lg-4">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
          <h5 class="mb-0 text-success">
            <i class="bi bi-receipt me-2"></i> Recent Payments
          </h5>
          <a asp-controller="Payment" asp-action="Index" class="btn btn-sm btn-outline-success">
            View All <i class="bi bi-arrow-right ms-1"></i>
          </a>
        </div>
        <div class="card-body">
          @if(Model.RecentPayments.Any())
          {
            <div class="list-group list-group-flush">
              @foreach(var payment in Model.RecentPayments)
              {
                <div class="list-group-item border-start border-4 border-success ps-3">
                  <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                      <div class="d-flex justify-content-between">
                        <h6 class="mb-1 fw-bold">@payment.Amount.ToString("C")</h6>
                        <span class="badge bg-light text-dark">@payment.Method</span>
                      </div>
                      <p class="mb-1 text-muted small">
                        <i class="bi bi-receipt me-1"></i> Receipt #@payment.Id
                      </p>
                      <p class="mb-1">
                        <span class="badge bg-light text-dark">@payment.Purpose</span>
                      </p>
                      <p class="mb-0 text-muted small">
                        <i class="bi bi-calendar me-1"></i> @payment.PaymentDate.ToString("MMM dd, yyyy HH:mm")
                      </p>
                    </div>
                  </div>
                </div>
              }
            </div>
          }
          else
          {
            <div class="text-center py-4">
              <div class="mb-3">
                <i class="bi bi-receipt fs-1 text-muted"></i>
              </div>
              <h5 class="text-muted">No recent payments</h5>
              <p class="text-muted small mt-2">Make your first payment to see it here</p>
              <a asp-controller="Rentals" asp-action="Index" class="btn btn-success mt-3">
                <i class="bi bi-credit-card me-1"></i> Make Payment
              </a>
            </div>
          }
        </div>
      </div>
    </div>
  </div>

  
</div>

@section Scripts {
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <script>
    
    const rentalsCtx = document.getElementById('rentalsChart').getContext('2d');
    new Chart(rentalsCtx, {
        type: 'line',
        data: {
            labels: @Html.Raw(Json.Serialize(Model.Months)),
            datasets: [{
                label: 'Rentals',
                data: @Html.Raw(Json.Serialize(Model.RentalsPerMonth)),
                borderColor: '#4361ee',
                backgroundColor: 'rgba(67, 97, 238, 0.1)',
                borderWidth: 3,
                pointBackgroundColor: '#4361ee',
                pointRadius: 4,
                fill: true,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        stepSize: 1
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });

    
    const paymentsCtx = document.getElementById('paymentsChart').getContext('2d');
    new Chart(paymentsCtx, {
        type: 'bar',
        data: {
            labels: @Html.Raw(Json.Serialize(Model.Months)),
            datasets: [{
                label: 'Payments ($)',
                data: @Html.Raw(Json.Serialize(Model.PaymentsPerMonth)),
                backgroundColor: 'rgba(38, 198, 218, 0.7)',
                borderColor: '#0288d1',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
  </script>

  <style>
    .bg-gradient-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .text-purple {
      color: #7209b7 !important;
    }

    .bg-purple {
      background-color: #7209b7 !important;
    }

    .table-hover tbody tr:hover {
      background-color: rgba(67, 97, 238, 0.05);
    }

    .card {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

      .card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
      }
  </style>
}