@model Web.ViewModels.ActiveRentalsViewModel

@{
  ViewData["Title"]="Active Rentals";
}

<div class="container-fluid mt-4">
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <h3 class="mb-0">
          <i class="bi bi-clock-history text-primary"></i> Active Rentals

        </h3>
        <a asp-controller="Car" asp-action="Index" class="btn btn-primary">
          <i class="bi bi-plus-circle"></i> Rent New Car
        </a>
      </div>
    </div>
  </div>

  <!-- Active Rentals Grid/Table -->
  @if(Model.Rentals.Any())
  {
    <div class="card shadow-sm">
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover table-striped mb-0">
            <thead class="table-primary">
              <tr>
                <th>Contract ID</th>
                <th>Car Model</th>
                <th>Plate Number</th>
                <th>Start Date</th>
                <th>End Date</th>
                <th>Duration</th>
                <th>Daily Price</th>
                <th>Total Amount</th>
                <th>Paid Amount</th>
                <th>Remaining</th>
                <th>Payment Status</th>
                <th class="text-center">Actions</th>
              </tr>
            </thead>
            <tbody>
              @foreach(var rental in Model.Rentals)
              {
                var remaining = (rental.FinalAmount??rental.TotalAmount)-rental.PaidAmount;
                var paymentPercentage = rental.TotalAmount>0
                ? (int)((rental.PaidAmount/rental.TotalAmount)*100)
                : 0;

                <tr>
                  <td>
                    <strong>#@rental.Id</strong>
                  </td>
                  <td>
                    <strong>@rental.Car?.Model</strong>
                    <br>
                    <small class="text-muted">@rental.Car?.Year</small>
                  </td>
                  <td>
                    <strong class="text-primary">@rental.Car?.PlateNumber</strong>
                  </td>
                  <td>
                    @rental.StartDate.ToString("MMM dd, yyyy")
                    <br>
                    <small class="text-muted">@rental.StartDate.ToString("hh:mm tt")</small>
                  </td>
                  <td>
                    @rental.EndDate.ToString("MMM dd, yyyy")
                    <br>
                    <small class="text-muted">@rental.EndDate.ToString("hh:mm tt")</small>
                  </td>
                  <td>
                    <span class="badge bg-info text-dark">
                      @((rental.EndDate-rental.StartDate).Days+1) days
                    </span>
                  </td>
                  <td>
                    <strong class="text-success">@rental.DailyPrice.ToString("C")</strong>
                  </td>
                  <td>
                    <strong>@rental.TotalAmount.ToString("C")</strong>
                  </td>
                  <td>
                    <span class="text-success fw-bold">@rental.PaidAmount.ToString("C")</span>
                  </td>
                  <td>
                    @if(remaining>0)
                    {
                      <span class="text-danger fw-bold">@remaining.ToString("C")</span>
                    }
                    else
                    {
                      <span class="badge bg-success">Paid</span>
                    }
                  </td>
                  <td>
                    <div class="mb-1">
                      <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-success" role="progressbar"
                             style="width: @paymentPercentage%"></div>
                      </div>
                    </div>
                    <small class="text-muted">@paymentPercentage% Paid</small>
                  </td>
                  <td class="text-center">
                    <div class="d-flex justify-content-center gap-1">
                      <a asp-action="Details" asp-route-rentalId="@rental.Id"
                         class="btn btn-sm btn-outline-primary" title="Details">
                        <i class="bi bi-eye"></i>
                      </a>

                      @if(remaining>0)
                      {
                        <a asp-controller="Payment" asp-action="MakePayment"
                           asp-route-rentalId="@rental.Id"
                           class="btn btn-sm btn-success" title="Pay">
                          <i class="bi bi-credit-card"></i>
                        </a>
                      }

                      <a asp-action="Extend" asp-route-rentalId="@rental.Id"
                         class="btn btn-sm btn-warning" title="Extend">
                        <i class="bi bi-clock"></i>
                      </a>

                      <a asp-action="Close" asp-route-rentalId="@rental.Id"
                         class="btn btn-sm btn-primary" title="Close">
                        <i class="bi bi-check"></i>
                      </a>
                    </div>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>
  }
  else
  {
    <div class="card shadow-sm">
      <div class="card-body text-center py-5">
        <div class="mb-3">
          <i class="bi bi-inbox fs-1 text-muted"></i>
        </div>
        <h5 class="text-muted mb-3">No Active Rentals Found</h5>

        @if(!string.IsNullOrWhiteSpace(Model.SearchTerm))
        {
          <p class="text-muted mb-3">
            No rentals match your search: "<strong>@Model.SearchTerm</strong>"
          </p>
          <a asp-action="Active" class="btn btn-outline-secondary me-2">
            <i class="bi bi-arrow-counterclockwise"></i> Clear Search
          </a>
        }

        <a asp-controller="Car" asp-action="Index" class="btn btn-primary">
          <i class="bi bi-car-front"></i> Browse Cars to Rent
        </a>
      </div>
    </div>
  }
</div>

@section Scripts {
  <style>
    .table {
      font-size: 0.9rem;
    }

      .table th {
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
        padding: 1rem;
      }

      .table td {
        vertical-align: middle;
        padding: 0.75rem 1rem;
      }

    .table-hover tbody tr:hover {
      background-color: rgba(67, 97, 238, 0.05);
    }

    .btn-sm {
      padding: 0.25rem 0.5rem;
      font-size: 0.875rem;
    }

    .badge {
      padding: 0.4rem 0.6rem;
      font-size: 0.75rem;
    }

    .progress {
      border-radius: 4px;
      overflow: hidden;
    }


    .table th,
    .table td {
      padding: 0.5rem;
    }

      .table td small {
        display: block;
        margin-top: 0.25rem;
      }

    }
  </style>
}